---
// 1. Import the new game components
import SymbioticSwarm from './SymbioticSwarm.astro';
import UnforgettingGuard from './UnforgettingGuard.astro';
---

<div id="game-section-wrapper">

  <div id="game-menu">
    <h3>My Game Experiments</h3>
    <p>A couple of small games I built to experiment with AI behaviors.</p>
    <div class="game-card-container">
      
      <div class="game-card">
        <img src="/img/symbiotic_swarm_promo.png" alt="Symbiotic Swarm Game" />
        <h4>Symbiotic Swarm</h4>
        <p>A 90-second survival game where you spawn an AI swarm to defend you.</p>
        <button onclick="playGame('swarm')">Play Game</button>
      </div>

      <div class="game-card">
        <img src="/img/unforgetting_guard_promo.png" alt="Unforgetting Guard Game" />
        <h4>The Unforgetting Guard</h4>
        <p>A stealth game where the guard uses A* pathfinding and learns from your past routes.</p>
        <button onclick="playGame('guard')">Play Game</button>
      </div>

    </div>
  </div>

  <SymbioticSwarm />
  <UnforgettingGuard />

</div>

<style>
  #game-menu {
    width: 100%;
    height: 100%;
    padding: 2rem 3rem;
    color: #eee;
    overflow-y: auto;
  }
  #game-menu h3 {
    font-size: 2rem;
    color: #00FFFF;
    text-align: center;
    margin-bottom: 1rem;
  }
  #game-menu p {
    text-align: center;
    font-size: 1.1rem;
    color: #ccc;
    max-width: 800px;
    margin: 0 auto 2rem auto;
  }
  .game-card-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1.5rem; /* CHANGED: Reduced gap */
  }
  
  /* --- ALL CARD STYLES UPDATED --- */
  .game-card {
    background: #222;
    border: 1px solid #444;
    border-radius: 8px;
    width: 300px; /* CHANGED: Was 350px */
    padding: 1rem;  /* CHANGED: Was 1.5rem */
    text-align: left;
    transition: all 0.2s ease;
    display: flex; /* ADDED: Use flexbox for layout */
    flex-direction: column; /* ADDED: Stack items vertically */
  }
  .game-card:hover {
    border-color: #00FFFF;
    transform: translateY(-5px);
  }
  .game-card img {
    width: 100%;
    height: 160px; /* CHANGED: Was 200px */
    object-fit: cover;
    border-radius: 4px;
    background: #111;
    border: 1px solid #555;
  }
  .game-card h4 {
    font-size: 1.25rem; /* CHANGED: Was 1.5rem */
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    color: #fff;
  }
  .game-card p {
    font-size: 0.9rem; /* CHANGED: Was 1rem */
    text-align: left;
    color: #bbb;
    margin-bottom: 1rem; /* CHANGED: Was 1.5rem */
    flex-grow: 1; /* ADDED: Makes text fill space, pushing button down */
  }
  .game-card button {
    width: 100%;
    padding: 0.6rem; /* CHANGED: Was 0.75rem */
    font-size: 0.9rem; /* CHANGED: Was 1rem */
    font-weight: bold;
    color: #111;
    background: #00FF00;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-top: auto; /* ADDED: Pushes button to bottom */
  }

  /* This is the key: 
    We use a :global selector to hide the game component wrappers.
  */
  :global(.game-component-wrapper) {
    display: none;
    width: 100%;
    height: 100%;
  }
</style>

<script is:inline>
  let activeSketch = null; // This will hold the running p5.js instance

  // This function is GLOBAL so our games can call it
  window.showGameMenu = function() {
    // 1. If a game is running, destroy it
    if (activeSketch) {
      activeSketch.remove(); // p5.js function to stop and remove canvas
      activeSketch = null;
    }

    // 2. Hide all game wrappers
    // Use querySelectorAll for easier scaling
    document.querySelectorAll('.game-component-wrapper').forEach(wrapper => {
      wrapper.style.display = 'none';
    });
    
    // 3. Show the game menu
    document.getElementById('game-menu').style.display = 'block';
  }

  // This function starts a game
  window.playGame = function(gameId) {
    // 1. Clean up any old game first
    if (activeSketch) {
      window.showGameMenu();
    }
    
    // 2. Hide the menu
    document.getElementById('game-menu').style.display = 'none';

    // 3. Start the correct game
    if (gameId === 'swarm') {
      const container = document.getElementById('swarm-game-container');
      document.getElementById('swarm-game-wrapper').style.display = 'block';
      // 'p5' is now guaranteed to be globally available!
      activeSketch = new p5(window.swarmSketch, container);

    } else if (gameId === 'guard') {
      const container = document.getElementById('guard-game-container');
      document.getElementById('guard-game-wrapper').style.display = 'block';
      // 'p5' is now guaranteed to be globally available!
      activeSketch = new p5(window.guardSketch, container);
    }
  }

  // Ensure menu is shown on first load
  document.addEventListener('astro:page-load', () => {
     window.showGameMenu();
  });
</script>